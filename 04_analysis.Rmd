---
title: "04_analysis"
author: "Marina Bozinovic"
date: "2023-05-11"
output: html_document
---
# Exploratory Analysis and Modeling for all 13 buoys

Required Packages
```{r}
library(tidyverse)
library(mgcv)
```

Read in RDS files of each buoy + all environ variables + AIS (pending)
```{r}
ftlist <- dir("data/", recursive=TRUE, full.names=TRUE, pattern="fulltrack")

for (ft in ftlist) {
  df <- readRDS(ft)
  assign(paste0("fulltrack", substr(ft, 15, 16)), df)
}

```

Bind ALL DRIFTS into one dataframe
```{r}
allDrifts <- rbind(fulltrack07, fulltrack08, fulltrack10, fulltrack12, fulltrack13, fulltrack14, 
                   fulltrack16, fulltrack18, fulltrack19, fulltrack20, fulltrack21, fulltrack22, fulltrack23)
```


### Third octave levels histograms

```{r all-drifts-all-freq-histogram}
# create list of fulltrack dfs from global environment to loop through
dlist <- grep(pattern = "fulltrack", names(.GlobalEnv), value = T)

# all Drifts - all TOL bands, facet wrap
for (ft in dlist) {
pivot1 <- get(ft) %>%
  pivot_longer(cols = starts_with("TOL") | starts_with("BB"), names_to = "SL", values_to = "Hz")    # Pivot longer for histogram facet grid

print(ggplot(data = pivot1, aes(Hz, fill = factor(BWpresence))) +
  geom_histogram(binwidth = 3, color = "black") +
  theme_classic() +
  ggtitle(paste0("Distribution of third octave level intensities: Drift ", substr(ft,10,11))) +
  labs(x = "Sound Intensity (dB)") +
  guides(fill = guide_legend(title = "Whale Presence")) +
  scale_fill_manual(values = c("0" = "bisque1",
                               "1" = "brown4")) +
  theme(legend.position = c(0.7,0.8)) +
  facet_grid(~SL))
}

# Single plot for ALL DRIFTS
pivot3 <- allDrifts %>%
  pivot_longer(cols = starts_with("TOL") | starts_with("BB"), names_to = "SL", values_to = "Hz")    # Pivot longer for histogram facet grid

ggplot(data = pivot3, aes(Hz, fill = factor(BWpresence))) +
  geom_histogram(binwidth = 3, color = "black") +
  theme_classic() +
  ggtitle("Distribution of third octave level intensities: All Drifts Combined") +
  labs(x = "Sound Intensity (dB)") +
  guides(fill = guide_legend(title = "Whale Presence")) +
  scale_fill_manual(values = c("0" = "bisque1",
                               "1" = "brown4")) +
  theme(legend.position = c(0.7,0.8)) +
  facet_grid(~SL)

```

## ignore??
```{r drift-8-histogram}
#ggplot(data = pivot3, aes(Hz, fill = factor(BWpresence))) +
#  geom_histogram(binwidth = 1, color = "black") +
#  theme_classic() +
#  ggtitle("Distribution of Third-Octave Level (TOL) Intensities: Buoy 8") +
#  scale_x_continuous(name = "Sound Intensity (dB)") +
#  scale_fill_manual(name = "Beaked Whale Presence", 
#                    labels = c("0" = "Absent", "1" = "Present"),
#                    values = c("0" = "bisque1",
#                               "1" = "brown4")) +
#  theme(legend.position = c(0.6,0.7)) +
#  facet_wrap(~TOL, labeller = as_labeller(TOL.labs))
```


```{r all-drifts-two-freq-histogram}
# All Drifts - TOL bands 125 and 2000 only

TOL.labs <- c(`TOL_125` = "TOL at 125 Hz", 
              `TOL_2000` = "TOL at 2000 Hz") #creates label names for plots below

for (ft in dlist) {
pivot2 <- get(ft) %>%
  dplyr::select(-TOL_63, -TOL_20000, -TOL_5000) %>%
  pivot_longer(cols = starts_with("TOL"), names_to = "TOL", values_to = "Hz")    # Pivot longer for histogram facet grid

print(ggplot(data = pivot2, aes(Hz, fill = factor(BWpresence))) +
  geom_histogram(binwidth = 1, color = "black") +
  theme_classic() +
  ggtitle(paste0("Distribution of Third-Octave Level (TOL) Intensities: Drift ", substr(ft,10,11))) +
  scale_x_continuous(name = "Sound Intensity (dB)") +
  scale_fill_manual(name = "Whale Presence", 
                    labels = c("0" = "Absent", "1" = "Present"),
                    values = c("0" = "bisque1",
                               "1" = "brown4")) +
  theme(legend.position = c(0.6,0.7)) +
  facet_wrap(~TOL, labeller = as_labeller(TOL.labs)))
}


# Single plot for ALL DRIFTS combined
pivot4 <- allDrifts %>%
  dplyr::select(-TOL_63, -TOL_20000, -TOL_5000) %>%
  pivot_longer(cols = starts_with("TOL"), names_to = "TOL", values_to = "Hz")    # Pivot longer for histogram facet grid

ggplot(data = pivot4, aes(Hz, fill = factor(BWpresence))) +
  geom_histogram(binwidth = 1, color = "black") +
  theme_classic() +
  ggtitle("Distribution of Third-Octave Level (TOL) Intensities: All Drifts Combined") +
  scale_x_continuous(name = "Sound Intensity (dB)") +
  scale_fill_manual(name = "Whale Presence", 
                    labels = c("0" = "Absent", "1" = "Present"),
                    values = c("0" = "bisque1",
                               "1" = "brown4")) +
  theme(legend.position = c(0.6,0.7)) +
  facet_wrap(~TOL, labeller = as_labeller(TOL.labs))
```

Timeline of drifts in ocean
```{r}
ggplot(data = allDrifts, aes(x = UTC, y = station*(-1))) + geom_point(aes(color = factor(station)))

#Note the break in drift 20 - I think it wasn't transmitting for several days (11/15-11/19)
```

Avg sound levels by band (scatterplot)
```{r}
avgdB <- TO_12 %>%
  summarize(TOL_25 = mean(TOL_25),
            TOL_31.5 = mean(TOL_31.5),
            TOL_40 = mean(TOL_40),
            TOL_50 = mean(TOL_50),
            TOL_63 = mean(TOL_63),
            TOL_80 = mean(TOL_80),
            TOL_100 = mean(TOL_100),
            TOL_125 = mean(TOL_125),
            TOL_160 = mean(TOL_160),
            TOL_200 = mean(TOL_200),
            TOL_250 = mean(TOL_250),
            TOL_315 = mean(TOL_315),
            TOL_400 = mean(TOL_400),
            TOL_500 = mean(TOL_500),
            TOL_630 = mean(TOL_630),
            TOL_800 = mean(TOL_800),
            TOL_1000 = mean(TOL_1000),
            TOL_1250 = mean(TOL_1250),
            TOL_1600 = mean(TOL_1600),
            TOL_2000 = mean(TOL_2000),
            TOL_2500 = mean(TOL_2500),
            TOL_3150 = mean(TOL_3150),
            TOL_4000 = mean(TOL_4000),
            TOL_5000 = mean(TOL_5000),
            TOL_6300 = mean(TOL_6300),
            TOL_8000 = mean(TOL_8000),
            TOL_10000 = mean(TOL_10000),
            TOL_12500 = mean(TOL_12500),
            TOL_16000 = mean(TOL_16000),
            TOL_20000 = mean(TOL_20000)) %>%
  pivot_longer(cols = TOL_25:TOL_20000,
               names_to = "frequency",
               values_to="dB")


ggplot(avgdB, aes(x = factor(frequency, levels = unique(frequency)), y = dB)) + 
  geom_point() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

Box plots
```{r}
TO_longer <- pivot_longer(TO_14, cols = TOL_25:TOL_20000,
               names_to = "frequency",
               values_to="dB")
ggplot(TO_longer, aes(x = factor(frequency, levels = unique(frequency)), y = dB)) + 
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# Violin plot
ggplot(TO_longer, aes(x = factor(frequency, levels = unique(frequency)), y = dB)) + 
  geom_violin() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```



Scatterplots

```{r}
# SST vs TOL 2000
ggplot(data = allDrifts, aes(x = sst_mean, y = `TOL_2000`)) +
  geom_point(aes(color = species)) + scale_color_discrete(na.translate=FALSE)

# SST over time (strange plot)
ggplot(allDrifts, aes(x = UTC, y = sst_mean)) +
  geom_line() +
  geom_point(aes(color = species)) +
  scale_color_discrete(na.translate=FALSE)
  #geom_smooth(method = "loess")


# Depth vs TOL 125
ggplot(data = allDrifts, aes(x = depth, y = `TOL_125`)) +
  geom_line() +
  geom_point(aes(color = species)) +
  scale_color_discrete(na.translate=FALSE)

#Mean depth over time
#ggplot(means_08, aes(x = `as.Date(UTC)`, y = depth*(-1))) +
#  geom_line()

# Chlorophyll vs TOL 125
ggplot(data = allDrifts, aes(x = chlorophyll_mean, y = `TOL_125`)) +
  geom_point(aes(color = species)) + scale_color_discrete(na.translate=FALSE)

# CHl over time
ggplot(allDrifts, aes(x = UTC, y = chlorophyll_mean)) +
  geom_line() +
  geom_point(aes(color = species)) +
  scale_color_discrete(na.translate=FALSE)
  #geom_smooth(method = "loess")

# Mixed Layer Depth vs TOL125 with species
ggplot(data = allDrifts, aes(x = mldDepth, y = `TOL_125`)) +
  geom_point(aes(color = species)) + scale_color_discrete(na.translate=FALSE)

# Mixed Layer Depth over time
ggplot(allDrifts, aes(x = UTC, y = mldDepth*(-1))) +
  geom_line() +
  geom_point(aes(color = species)) +
  scale_color_discrete(na.translate=FALSE)

ggplot(data = allDrifts, aes(x = `TOL_125`, y = bathy_slope)) +
  geom_point(aes(color = species)) + scale_color_discrete(na.translate=FALSE)
  
```



Facet Grids for Env. Variables
```{r}
#Get avg daily environmental variables
means <- allDrifts %>%
  group_by(as.Date(UTC))%>%
  summarize(sst_mean = mean(sst_mean),
            dist_slope = mean(dist2slope),
            depth = mean(depth),
            slope = mean(bathy_slope),
            dist_shore = mean(dist2shore),
            chlorophyll_mean = mean(chlorophyll_mean),
            ssh_mean = mean(ssh_mean),
            mldDepth = mean(mldDepth),
            mldTemp = mean(mldTemp),
            ttDepth = mean(ttDepth),
            ttTemp = mean(ttTemp),
            temp400 = mean(temp400),
            sal400 = mean(sal400),
            curlmean = mean(curl_mean),
            Wh_presence = sum(BWpresence))
```

```{r}
#For surface/depth variables USING DAILY MEAN VARIABLES
trackLong <- means %>%
  pivot_longer(cols = sst_mean:ssh_mean,
               names_to="parameter",
               values_to="value") %>%
  filter(parameter %in% c("sst_mean", "dist_shore", "chlorophyll_mean", "ssh_mean")) %>%
  rename(Date = `as.Date(UTC)`)

p <- ggplot(data = trackLong, aes(x = Date, y = value)) +
  geom_line()

p + facet_grid(parameter ~ ., scales = "free_y")
  

# For MLD/Thermocline variables 
trackLong2 <- allDrifts %>%
  pivot_longer(cols = mldDepth:sal400,
               names_to="parameter",
               values_to="value") %>%
  filter(parameter %in% c("mldDepth", "mldTemp", "ttDepth", "ttTemp", "temp400", "sal400")) %>%
    rename(Date = UTC) %>%
    subset(species!="?BW")

q <- ggplot(data = trackLong2, aes(x = Date, y = value)) +
  geom_line() + geom_point(aes(color = species)) + scale_color_discrete(na.translate=FALSE)
q + facet_grid(parameter ~ ., scales = "free_y")

# For temp400 and salinity400 variables
env.labs <- c(`sal400` = "Salinity at 400m", 
              `temp400` = "Temperature at 400m")

trackLong3 <- allDrifts %>%
  pivot_longer(cols = temp400:sal400,
               names_to="parameter",
               values_to="value") %>%
  filter(parameter %in% c("temp400", "sal400")) %>%
  rename(`Date (2018)` = UTC)

q <- ggplot(data = trackLong3, aes(x = `Date (2018)`, y = value)) +
  #geom_line() + 
  geom_point(aes(color = species)) + 
  scale_color_discrete(na.translate=FALSE, labels = c("ZC" = "Cuvier's", "BW43" = "BW43", "BW" = "BW"))
q + facet_grid(parameter ~ ., scales = "free_y", labeller = as_labeller(env.labs))
```


NEEDS FIXING/LOOP/AIS DATA FOR OTHER DRIFTS
Co-occurrence plots of drift 8 and vessels 
```{r}
#### 09/04/18 co-occurrence of vessel and drift within 10 km
track08_09.04 <- tracks_SS_08 %>%
  filter(UTC >= "2018-09-04 00:00:00" & UTC <= "2018-09-05 00:00:00")

ggplot(data = track08_09.04, aes(x = UTC, y = `TOL_125`)) +
  geom_vline(xintercept = as.POSIXct("2018-09-04 14:13:00"), color = "yellow", linewidth = 2) +
  geom_text(aes(as.POSIXct("2018-09-04 14:13:00"), 88, label = "Enter vessel", hjust = 1.0)) +
  geom_vline(xintercept = as.POSIXct("2018-09-04 15:17:00"), color = "yellow", linewidth = 2) +
  geom_text(aes(as.POSIXct("2018-09-04 15:13:00"), 87, label = "Exit vessel", hjust = -0.1)) +
  geom_line() + 
  geom_point(data = track08_09.04, aes(color = species, size = 2)) +
  scale_color_discrete(na.translate=FALSE) +
  scale_size_continuous(guide = "none") +
  ggtitle("Sound levels during co-occurrence of Drift 8 and a vessel on 09-04-18\n(Within 7 km)") +
  scale_y_continuous(name = "Sound Intensity (dB) at TOL 125 Hz") +
  scale_color_discrete(na.translate=FALSE, labels = c("ZC" = "Cuvier's", "BW43" = "BW43"))

#### 09/05/18 co-occurrence of vessel and drift within 10 km.
track08_09.05 <- tracks_SS_08 %>%
  filter(UTC >= "2018-09-04 21:00:00" & UTC <= "2018-09-06 00:00:00")

ggplot(data = track08_09.05, aes(x = UTC, y = `TOL_125`)) +
  geom_vline(xintercept = as.POSIXct("2018-09-05 01:33:00"), color = "yellow", linewidth = 1) +
  geom_text(aes(as.POSIXct("2018-09-05 01:33:00"), 86, label = "Enter vessel", hjust = 1)) +
  geom_vline(xintercept = as.POSIXct("2018-09-05 02:08:00"), color = "yellow", linewidth = 1) +
  geom_text(aes(as.POSIXct("2018-09-05 02:08:00"), 85, label = "Exit vessel", hjust = -0.1)) +
  geom_line() + 
  geom_point(data = track08_09.05, aes(color = species, size = 2)) +
  scale_size_continuous(guide = "none") +
  ggtitle("Sound levels during co-occurrence of Drift 8 and a vessel on 09-05-18\n(Within 5 km)") +
  scale_y_continuous(name = "Sound Intensity (dB) at TOL 125 Hz") +
  scale_color_discrete(na.translate=FALSE, labels = c("ZC" = "Cuvier's", "BW43" = "BW43"))

#### 09/10/18 co-occurrence of vessel and drift within 10 km.
track08_09.10 <- tracks_SS_08 %>%
  filter(UTC >= "2018-09-10 00:00:00" & UTC <= "2018-09-11 00:00:00")

ggplot(data = track08_09.10, aes(x = UTC, y = `TOL_125`)) +
  geom_vline(xintercept = as.POSIXct("2018-09-10 12:58:00"), color = "yellow", linewidth = 1) +
  geom_text(aes(as.POSIXct("2018-09-10 12:58:00"), 86, label = "Enter vessel", hjust = 1)) +
  geom_vline(xintercept = as.POSIXct("2018-09-10 14:01:00"), color = "yellow", linewidth = 1) +
  geom_text(aes(as.POSIXct("2018-09-10 14:01:00"), 85, label = "Exit vessel", hjust = -0.1)) +
  geom_line() +
  geom_point(data = track08_09.10, aes(color = species, size = 2)) +
  scale_size_continuous(guide = "none") +
  ggtitle("Sound levels during co-occurrence of Drift 8 and a vessel on 09-10-18\n(Within 2 km)") +
  scale_y_continuous(name = "Sound Intensity (dB) at TOL 125 Hz") +
  scale_color_discrete(na.translate=FALSE, labels = c("ZC" = "Cuvier's", "BW43" = "BW43"))


#### 09/22/18 co-occurrence of vessel and drift within 10 km
track08_09.22 <- tracks_SS_08 %>%
  filter(UTC >= "2018-09-22 00:00:00" & UTC <= "2018-09-23 00:00:00")

ggplot(data = track08_09.22, aes(x = UTC, y = `TOL_125`)) +
  geom_vline(xintercept = as.POSIXct("2018-09-22 19:13:00"), color = "yellow", linewidth = 1) +
  geom_text(aes(as.POSIXct("2018-09-22 19:13:00"), 86, label = "Enter vessel", hjust = 1)) +
  geom_vline(xintercept = as.POSIXct("2018-09-22 19:34:00"), color = "yellow", linewidth = 1) +
  geom_text(aes(as.POSIXct("2018-09-22 19:34:00"), 85, label = "Exit vessel", hjust = -0.1)) +
  geom_line() + 
  geom_point(data = track08_09.22, aes(color = species, size = 2)) +
  scale_size_continuous(guide = "none") +
  ggtitle("Sound levels during co-occurrence of Drift 8 and a vessel on 09-22-18\n(Within 9 km)") +
  scale_y_continuous(name = "Sound Intensity (dB) at TOL 125 Hz") +
  scale_color_discrete(na.translate=FALSE, labels = c("ZC" = "Cuvier's", "BW43" = "BW43"))

#### 09/23/18 co-occurrence of vessel and drift within 10 km. NO whale detections in this time period.
track08_09.23 <- tracks_SS_08 %>%
  filter(UTC >= "2018-09-23 00:00:00" & UTC <= "2018-09-24 00:00:00")

ggplot(data = track08_09.23, aes(x = UTC, y = `TOL_125`)) +
  geom_vline(xintercept = as.POSIXct("2018-09-23 03:55:00"), color = "yellow", linewidth = 1) +
  geom_text(aes(as.POSIXct("2018-09-23 03:55:00"), 86, label = "Enter vessel", hjust = 1)) +
  geom_vline(xintercept = as.POSIXct("2018-09-23 04:23:00"), color = "yellow", linewidth = 1) +
  geom_text(aes(as.POSIXct("2018-09-23 04:23:00"), 85, label = "Exit vessel", hjust = -0.1)) +
  geom_line() +
  ggtitle("Sound levels during co-occurrence of Drift 8 and a vessel on 09-23-18\n(Within 6 km)") +
  scale_y_continuous(name = "Sound Intensity (dB) at TOL 125 Hz") +
  scale_color_discrete(na.translate=FALSE, labels = c("ZC" = "Cuvier's", "BW43" = "BW43"))
```


IS THIS HELPFUL??
Whale Occurrences
```{r}
# Filter Drift 8 by Whale presence and absence
W1 <- tracks_SS_08 %>%
  filter(Wpresence == 1)
W0 <- tracks_SS_08 %>%
  filter(Wpresence == 0)

ggplot(data = tracks_SS_08, mapping = aes(TOL_125)) + geom_histogram(binwidth = 0.1, color = "black")

ggplot() + 
  geom_histogram(data = W0, aes(TOL_5000), binwidth = 0.5, fill = "black", color = "white") +
  geom_histogram(data = W1, aes(TOL_5000), binwidth = 0.5, fill = "yellow", color = "black")

# Percent of time BWs are detected
print(paste(nrow(W1) / nrow(tracks_SS_08) * 100,"%"))

# Most abundant whale species when whale is detected (remove NA values)
allDrifts %>%
  filter(!is.na(species)) %>%
  ggplot() + geom_bar(aes(species))

# Sound levels whales are exposed to by species
ZC <- allDrifts %>%
  filter(species == "ZC")

BW43 <- allDrifts %>%
  filter(species == "BW43")

BB <- allDrifts %>%
  filter(species == "BB")

BWC <- allDrifts %>%
  filter(species == "BWC")

BW37V <- allDrifts %>%
  filter(species == "BW37V")

PM <- allDrifts %>%
  filter(species == "PM")

print(max(ZC$TOL_125))
print(max(BW43$TOL_125))
print(max(BB$TOL_125))
print(max(BWC$TOL_125))
print(max(BW37V$TOL_125))
print(max(PM$TOL_125))

  
ggplot() + geom_histogram(data = ZC, mapping = aes(TOL_125), binwidth = 0.2, fill = "brown", color = "white") +
  geom_histogram(data = BW43, mapping = aes(TOL_125), binwidth = 0.2, fill = "yellow", color = "white") +
  theme_classic()
```


Density Plots - Species at TOL sound levels
```{r density-plots}
# Broadband
for (ft in dlist) {
plt <- get(ft) %>%
  filter(!is.na(species))

  print(ggplot(data = plt, aes(`BB_20.24000`, fill = species)) + 
  geom_density(alpha = 0.5) +
  ggtitle(paste0("Broadband Drift ", substr(ft, 10, 11))) +
  scale_x_continuous(name = "Sound Intensity (dB)") +
  scale_fill_discrete(labels = c("ZC" = "Cuvier's", "BW43" = "BW43")))
}

# Broadband SINGLE PLOT ALL DRIFTS
allDrifts %>%
  filter(!is.na(species)) %>%
  ggplot(aes(`BB_20.24000`, fill = species)) + 
  geom_density(alpha = 0.5) +
  ggtitle("Broadband ALL Drifts Combined") +
  scale_x_continuous(name = "Sound Intensity (dB)") +
  scale_fill_discrete(labels = c("ZC" = "Cuvier's", "BW43" = "BW43"))
 
# TOL 63
for (ft in dlist) {
plt <- get(ft) %>%
  filter(!is.na(species))

  print(ggplot(data = plt, aes(TOL_63, fill = species)) + 
  geom_density(alpha = 0.5) +
  ggtitle(paste0("TOL 63, Drift ", substr(ft, 10, 11))) +
  scale_x_continuous(name = "Sound Intensity (dB)") +
  scale_fill_discrete(labels = c("ZC" = "Cuvier's", "BW43" = "BW43")))
}

# TOL 63 SINGLE PLOT ALL DRIFTS
allDrifts %>%
  filter(!is.na(species)) %>%
  ggplot(aes(TOL_63, fill = species)) + 
  geom_density(alpha = 0.5) +
  ggtitle("TOL 63 ALL Drifts Combined") +
  scale_x_continuous(name = "Sound Intensity (dB)") +
  scale_fill_discrete(labels = c("ZC" = "Cuvier's", "BW43" = "BW43"))

# TOL 125
for (ft in dlist) {
plt <- get(ft) %>%
  filter(!is.na(species))

  print(ggplot(data = plt, aes(TOL_125, fill = species)) + 
  geom_density(alpha = 0.5) +
  ggtitle(paste0("TOL 125, Drift ", substr(ft, 10, 11))) +
  scale_x_continuous(name = "Sound Intensity (dB)") +
  scale_fill_discrete(labels = c("ZC" = "Cuvier's", "BW43" = "BW43")))
}

# TOL 125 SINGLE PLOT ALL DRIFTS
allDrifts %>%
  filter(!is.na(species)) %>%
  ggplot(aes(TOL_125, fill = species)) + 
  geom_density(alpha = 0.5) +
  ggtitle("TOL 125 ALL Drifts Combined") +
  scale_x_continuous(name = "Sound Intensity (dB)") +
  scale_fill_discrete(labels = c("ZC" = "Cuvier's", "BW43" = "BW43"))

# TOL 2000
for (ft in dlist) {
plt <- get(ft) %>%
  filter(!is.na(species))

  print(ggplot(data = plt, aes(TOL_2000, fill = species)) + 
  geom_density(alpha = 0.5) +
  ggtitle(paste0("TOL 2000, Drift ", substr(ft, 10, 11))) +
  scale_x_continuous(name = "Sound Intensity (dB)") +
  scale_fill_discrete(labels = c("ZC" = "Cuvier's", "BW43" = "BW43")))
}

# TOL 2000 SINGLE PLOT ALL DRIFTS
allDrifts %>%
  filter(!is.na(species)) %>%
  ggplot(aes(TOL_2000, fill = species)) + 
  geom_density(alpha = 0.5) +
  ggtitle("TOL 2000 ALL Drifts Combined") +
  scale_x_continuous(name = "Sound Intensity (dB)") +
  scale_fill_discrete(labels = c("ZC" = "Cuvier's", "BW43" = "BW43"))

# TOL 5000
for (ft in dlist) {
plt <- get(ft) %>%
  filter(!is.na(species))

  print(ggplot(data = plt, aes(TOL_5000, fill = species)) + 
  geom_density(alpha = 0.5) +
  ggtitle(paste0("TOL 5000, Drift ", substr(ft, 10, 11))) +
  scale_x_continuous(name = "Sound Intensity (dB)") +
  scale_fill_discrete(labels = c("ZC" = "Cuvier's", "BW43" = "BW43")))
}

# TOL 5000 SINGLE PLOT ALL DRIFTS
allDrifts %>%
  filter(!is.na(species)) %>%
  ggplot(aes(TOL_5000, fill = species)) + 
  geom_density(alpha = 0.5) +
  ggtitle("TOL 5000 ALL Drifts Combined") +
  scale_x_continuous(name = "Sound Intensity (dB)") +
  scale_fill_discrete(labels = c("ZC" = "Cuvier's", "BW43" = "BW43"))

# TOL 20,000
for (ft in dlist) {
plt <- get(ft) %>%
  filter(!is.na(species))

  print(ggplot(data = plt, aes(TOL_20000, fill = species)) + 
  geom_density(alpha = 0.5) +
  ggtitle(paste0("TOL 20000, Drift ", substr(ft, 10, 11))) +
  scale_x_continuous(name = "Sound Intensity (dB)") +
  scale_fill_discrete(labels = c("ZC" = "Cuvier's", "BW43" = "BW43")))
}

# TOL 20,000 SINGLE PLOT ALL DRIFTS
allDrifts %>%
  filter(!is.na(species)) %>%
  ggplot(aes(TOL_20000, fill = species)) + 
  geom_density(alpha = 0.5) +
  ggtitle("TOL 20,000 ALL Drifts Combined") +
  scale_x_continuous(name = "Sound Intensity (dB)") +
  scale_fill_discrete(labels = c("ZC" = "Cuvier's", "BW43" = "BW43"))
```

ARE THESE HELPFUL??
Histograms with whale presence/absence and environmental variables. Doesnt differentiate by species though
```{r}
# SST
ggplot(data = allDrifts, aes(sst_mean, fill = factor(BWpresence))) +
  geom_histogram(binwidth = 0.1, color = "black")

# Depth
ggplot(data = allDrifts, aes(depth, fill = factor(BWpresence))) +
  geom_histogram(binwidth = 100, color = "black")

# Bottom slope
ggplot(data = allDrifts, aes(bathy_slope, fill = factor(BWpresence))) +
  geom_histogram(binwidth = 1, color = "black")

# SSH
ggplot(data = allDrifts, aes(ssh_mean, fill = factor(BWpresence))) +
  geom_histogram(binwidth = 0.005, color = "black")

# Chlorophyll
ggplot(data = allDrifts, aes(chlorophyll_mean, fill = factor(BWpresence))) +
  geom_histogram(binwidth = 0.05, color = "black")

#Wind Curl
ggplot(data = allDrifts, aes(curl_mean, fill = factor(BWpresence))) +
  geom_histogram(binwidth = 0.0000005, color = "black")

# Mixed layer depth Depth
ggplot(data = allDrifts, aes(mldDepth, fill = factor(BWpresence))) +
  geom_histogram(binwidth = 0.25, color = "black")

# Mixed layer depth Temperature
ggplot(data = allDrifts, aes(mldTemp, fill = factor(BWpresence))) +
  geom_histogram(binwidth = 0.1, color = "black")

# Thermocline Depth
ggplot(data = allDrifts, aes(ttDepth, fill = factor(BWpresence))) +
  geom_histogram(binwidth = 0.75, color = "black")

#Thermocline temperature
ggplot(data = allDrifts, aes(ttTemp, fill = factor(BWpresence))) +
  geom_histogram(binwidth = 0.1, color = "black")

# Temperature at 400m
ggplot(data = allDrifts, aes(temp400, fill = factor(BWpresence))) +
  geom_histogram(binwidth = 0.03, color = "black")

# Salinity at 400 m
ggplot(data = allDrifts, aes(sal400, fill = factor(BWpresence))) +
  geom_histogram(binwidth = 0.005, color = "black")
```
### GAMs

```{r}
model3 <- gam(BWpresence ~ depth + TOL_125 + dist2shore + mldTemp, 
              data = allDrifts, family = binomial)
plot(model3)

#try fitting linear model

lm_depth <- lm(BWpresence ~ depth, data = allDrifts)
ggplot(allDrifts, aes(sst_mean, chlorophyll_mean)) +
  geom_point() +
  geom_smooth()
```
Categorical term
```{r}
# ALL variables, GAM
model1 <- gam(BWpresence>0 ~ s(BB_20.24000) + s(TOL_63) + s(TOL_125) + s(TOL_2000)
              + s(TOL_5000) + s(TOL_20000) + s(depth) + s(mldDepth) + s(Latitude)
              + s(Longitude) + s(sst_mean) + s(curl_mean) + s(dist2slope) 
              + s(bathy_slope) + s(dist2shore) + s(chlorophyll_mean) + s(ssh_mean) 
              + s(mldTemp) + s(ttDepth) + s(ttTemp) + s(temp400) + s(sal400),
              data = allDrifts, family = binomial, method = "REML")

# ALL variables, GLM
model1GLM <- glm(BWpresence ~ BB_20.24000 + TOL_63 + TOL_125 + TOL_2000
              + TOL_5000 + TOL_20000 + depth + mldDepth + Latitude
              + Longitude + sst_mean + curl_mean + dist2slope
              + bathy_slope + dist2shore + chlorophyll_mean + ssh_mean 
              + mldTemp + ttDepth + ttTemp + temp400 + sal400,
              data = allDrifts, family = binomial)

# By species? doesnt work, may need to create dummy variables
model2 <- gam(BWpresence ~ s(sst_mean, by = as.factor(species)), 
              data = allDrifts, family = binomial, method = "REML")

# Soundscape metrics only, GAM
model4 <- gam(BWpresence ~ s(BB_20.24000, k = 10) + 
                s(TOL_63, k = 10) + s(TOL_125, k = 10) + 
                s(TOL_2000, k = 10) + s(TOL_5000, k = 10) 
              + s(TOL_20000, k = 10),
              data = allDrifts, family = binomial, method = "REML")

# Soundscape metrics only, GLM
model4GLM <- glm(BWpresence ~ BB_20.24000 + TOL_63 + TOL_125 + TOL_2000
              + TOL_5000 + TOL_20000,
              data = allDrifts, family = binomial)

model125 <- gam(BWpresence ~ s(TOL_125, k = 10),
              data = allDrifts, family = binomial, method = "REML")
plot(model125, trans = plogis)
summary(model125)
gam.check(model125)

# Environmental var only
model5 <- gam(BWpresence ~ s(depth) + s(mldDepth) + s(Latitude)
              + s(Longitude) + s(sst_mean) + s(curl_mean) + s(dist2slope) 
              + s(bathy_slope) + s(dist2shore) + s(chlorophyll_mean) + s(ssh_mean) 
              + s(mldTemp) + s(ttDepth) + s(ttTemp) + s(temp400) + s(sal400),
              data = allDrifts, family = binomial, method = "REML")

plogis(coef(model1[1]))
summary(model1)
summary(model4)
summary(model5)
summary(model4GLM)
plot(model4GLM)
gam.check(model1)
gam.check(model4)

#Log odds scale (when used with family = binomial)
plot(model1, pages = 6)
plot(model4, pages = 4, trans = plogis)

#Probability scale + centered on the intercept + adding intercept-related uncertainty with seWithMean arg
plot(model1, pages = 14, trans = plogis,
     shift = coef(model1)[1])#,
     #seWithMean = TRUE)

plot(model2, pages = 1, trans = plogis,
     shift = coef(model2)[1])

plot(model4, pages = 6, trans = plogis,
     shift = coef(model4)[1])
```



### Plot maps for Powerpoint images

Set Parameters
```{r}
theme_set(theme_bw())
tmap_mode("plot")
```

Create sf objects and basemaps for maps (not needed for environmental variables)
```{r}
whales_8_10sf <- Wsf %>%                            
dplyr::filter(station == "8" | station == "10")

trackssf <- st_as_sf(tracks, coords = c("Longitude", "Latitude"), crs=4326)
trk_TOL_08 <- st_as_sf(tracks_SS_08, coords = c("Longitude", "Latitude"), crs=4326)
trk_TOL_10 <- st_as_sf(tracks_SS_10, coords = c("Longitude", "Latitude"), crs=4326)
trackBase <- get_tiles(whales_8_10sf, provider = "Esri.WorldShadedRelief")
allTrackbase <- get_tiles(trackssf, provider = "Stamen.TonerLite", zoom = 5)
```

Map of whole study area
```{r}
# Establish bounding box
bbox <- st_bbox(c(xmin = -110, 
            xmax = -128, 
            ymax = 44, 
            ymin = 30), crs = st_crs(4326))

#Establish basemap
allTrackbase <- get_tiles(bbox, provider = "Esri.WorldGrayCanvas", zoom = 5)

# Establish inset map
us_region <- st_bbox(c(xmin = -90,
            xmax = -120, 
            ymax = 48, 
            ymin = 25), crs = st_crs(4326))
usa <- get_tiles(us_region, provider = "Esri.WorldGrayCanvas", zoom = 4)

sg <- bb_poly(bb(tracks_sf))
inset <- tm_shape(usa) + tm_rgb() + tm_shape(sg) + tm_borders(col = "red")


#Map all tracks
main <- tm_shape(allTrackbase) + tm_rgb() +
  tm_shape(trackssf) +
  tm_grid(alpha = 0.6, col = "grey") +
  tm_dots(col = "darkblue", size = 0.001, legend.show = TRUE) +
  tm_scale_bar(width = 0.3, text.size = 3, position = c(0.2, 0.03)) +
  tm_compass(type = "arrow", position = c(0.05, 0.05), color.light = "white") +
  tm_add_legend('symbol',
                type = "line",
                col = "darkblue",
                labels = "Drifting buoy tracks",
                size = 1,
                lwd = 2)

vp <- viewport(x=0.66, y=0.8, width = 0.26, height=0.4)
main
print(inset,vp=vp)


# Map all tracks - ggplot
basemap2 <- as.data.frame(allTrackbase, xy = TRUE)
#ggplot() +
#  geom_tile(data = basemap, aes(x=x, y=y, fill = "basemap")) +
#  geom_sf(data = trackssf, mapping = aes(), color = "red")


# Map tracks 08 and 10 only
tm_shape(trackBase) + tm_rgb() + 
  tm_shape(trk_TOL_08) + tm_dots(col = "red", 
                                 legend.show = TRUE) +
  tm_shape(trk_TOL_10) + tm_dots(col = "green")

# Bounding box of drift tracks on map
lon2 <- -129.04666
lon1 <- -115.78247
lat1 <- 28.21790
lat2 <- 45.09226

basemap3 <- ne_countries(scale = "medium", type = "map_units", returnclass = "sf")

# Drift tracks
ggplot(data = basemap3) +
  geom_sf(fill = "antiquewhite") +
  coord_sf(xlim = c(lon2 - 1, lon1 + 1), ylim = c(lat1 - 1, lat2 + 1), expand = FALSE) +
  theme(panel.grid.major = element_blank()) +
  geom_path(data = tracks_sf, mapping = aes(x=long,y=lat, group = factor(station)), color = "deeppink") +
  theme(panel.background = element_rect(fill = "aliceblue"), 
        axis.text = element_blank(), axis.ticks = element_blank(), 
        axis.title = element_blank())
```

Map of soundscapes
```{r}
# CCES_08 + CCES_10 Broadband
tm_shape(trackBase) + tm_rgb() + 
  tm_shape(trk_TOL_08) + 
  tm_symbols(col = "BB_20-24000", 
             border.lwd = NA, 
             size = 0.4, 
             sizes.legend = 0.7, 
             n = 10) +
  tm_shape(trk_TOL_10) + 
  tm_symbols(col = "BB_20-24000",
             border.lwd = NA, 
             size = 0.4,
             n = 10) +
  tm_layout(legend.width = 0.5, 
            legend.position = c("right","top"),
            legend.bg.color = "lightblue")

#CCES_08 Third Octave Level
tm_shape(trackBase) + tm_rgb() + 
  tm_shape(trk_TOL_08) + 
  tm_symbols(col = "TOL_63", 
             border.lwd = NA, 
             size = 0.5, 
             n = 10) + 
  tm_layout(legend.width = 0.5, 
            legend.position = c("right","top")) + 
  tm_legend()

ggplot() + 
  geom_sf(data = trk_TOL_08, aes(color = TOL_125, size = TOL_125), show.legend = FALSE) +
  geom_sf(data = trk_TOL_10, aes(color = TOL_125, size = TOL_125)) +
  scale_x_continuous(limits = c(-130,-122)) + 
  scale_y_continuous(limits = c(35,39)) +
  scale_color_gradient(low = "navy", high = "yellow")+
  scale_size(range = c(1,12)) +
  annotation_scale(location = "br", width_hint = 0.2, plot_unit = "km") +
  theme(panel.border = element_rect(fill = NA),
        axis.text = element_blank(),
        axis.ticks = element_blank(), 
        axis.title = element_blank(),
        panel.background = element_blank(),
        legend.position = "none")
```

Map of whale detections
```{r}
# Whale detections
ggplot() +
  geom_point(data = whales8, mapping = aes(x=long, y=lat), shape = 21, color = "black", fill = "green4", size = 4) +
  geom_point(data = whales10, mapping = aes(x=long, y=lat), shape = 21, color = "black", fill = "green4", size = 4) +
  scale_x_continuous(limits = c(-130,-122)) + 
  scale_y_continuous(limits = c(35,39)) +
  annotation_scale(location = "br", width_hint = 0.2, plot_unit = "km") +
  theme(panel.border = element_rect(fill = NA),
        axis.text = element_blank(),
        axis.ticks = element_blank(), 
        axis.title = element_blank(),
        panel.background = element_blank()
        )
#ggsave("Wdetect.png")


```

Map of bathymetry
```{r}
# Bathymetry
bathym <- ggplot() +
    geom_raster(data = bathy_df, 
              mapping = aes(x=x, y=y,
                            fill = `gebco_bathy`)) +
  annotation_scale(location = "bl", width_hint = 0.4) +
  theme(axis.text = element_blank(), 
        axis.ticks = element_blank(), 
        axis.title = element_blank(),
        panel.background = element_blank(),
        panel.border = element_rect(fill = NA))


# Alternative Bathymetry (code from Ocean Tracking Network #https://www.youtube.com/watch?v=xT2F-Y9bKLk)
bgo <- getNOAA.bathy(lon1 = -122, lon2 = -130,
                     lat1 = 35, lat2= 39, resolution = 1)  # plot bounding box around drift 8 and 10
autoplot(bgo, geom = c("raster", "contour"), coast = TRUE, show.legend = FALSE) + 
  scale_fill_etopo() + #creates ggplot object
  annotation_scale(location = "br", width_hint = 0.2, plot_unit = "km") +
  theme(axis.text = element_blank(), 
        axis.ticks = element_blank(), 
        axis.title = element_blank(),
        panel.background = element_blank())

# Soundscape + bathymetry
whales08_sf <- Wsf %>%                            
  dplyr::filter(station == "8")

ggplot() +
  geom_raster(data = bathy_df, 
              mapping = aes(x=x, y=y,
                            fill = `gebco_bathy`), show.legend = FALSE) +
  #geom_contour(data = bathy_df, mapping = aes(x=x, y=y, z=gebco_bathy, linewidth = 0.1), color = "blue", linewidth = 0.01,) +
  geom_sf(data = trk_TOL_08, aes(color = TOL_125, size = TOL_125), show.legend = FALSE) +
  geom_sf(data = whales08_sf, aes(), color = "black") +
  annotation_scale(location = "br", width_hint = 0.2, plot_unit = "km") +
  scale_color_gradient(low = "beige", high = "hotpink") +
  scale_fill_etopo() +
  theme(axis.text = element_blank(), 
        axis.ticks = element_blank(), 
        axis.title = element_blank(),
        panel.background = element_blank(),
        panel.border = element_rect(fill = NA))
#ggsave("soundscape.png")
```

Map of AIS
```{r}
# Plot + crop to drift area
#basemap <- ne_countries(scale = "medium", returnclass = "sf")
#ggplot() + 
#  geom_sf(aes(), basemap) +
#  geom_path(data = AIS_sf, mapping = aes(x=LON,y=LAT, group = VesselName), #show.legend = F) + 
  #geom_point(data = AIS_sf, mapping = aes(x=LON,y=LAT, group = VesselName)) +
#  scale_x_continuous(limits = c(min(drift$long-0.7), max(drift$long + 0.7))) + 
#  scale_y_continuous(limits = c(min(drift$lat-0.7), max(drift$lat + 0.7)))


# AIS data
ggplot() + 
  geom_path(data = AIS_sf, mapping = aes(x=LON,y=LAT, group = VesselName, linewidth = 1), show.legend = F) +
  scale_x_continuous(limits = c(-131,-121)) + 
  scale_y_continuous(limits = c(34,40)) +
  theme(axis.text = element_blank(), 
        axis.ticks = element_blank(), 
        axis.title = element_blank(),
        panel.background = element_blank(),
        panel.border = element_rect(fill = NA))
#ggsave("AIS.png")
```


Map of Sea Surface Temp with rerddap, Drift 8 only
```{r}
# Multi-scale Ultra-high Resolution (MUR) SST Analysis fv04.1, Global, 0.01Â°, 2002-present, Daily
SSTInfo <- info('jplMURSST41') 
murSST <- griddap(SSTInfo, latitude = c(35, 39), longitude = c(-122, -130), 
                  time = c("2018-08-16", "2018-10-01"), 
                  fields = 'analysed_sst') # drift 8 dates only
SST <- murSST$data

# Raster of SST
ggplot() + 
  geom_tile(data = SST, aes(x = longitude, y = latitude, fill = analysed_sst)) +
  scale_fill_gradient(low = "darkblue", high = "yellow") +
  annotation_scale(location = "br", width_hint = 0.2, plot_unit = "km") +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(), 
        axis.title = element_blank(),
        panel.background = element_blank(),
        panel.border = element_rect(fill = NA),
        legend.position = "none")
```

Plot distance to continental slope
```{r}
ggplot() +
  geom_raster(data = bathy_df, 
              mapping = aes(x=x, y=y,
                            fill = `gebco_bathy`)) +
  geom_sf(data = tracks_SS_08, 
          mapping = aes(col = dist_slope)) +
  geom_sf(data = cont_slope) + scale_fill_continuous(high = "lightgreen", low = "blue")
  

# PLOT distance by TOL with whales
ggplot(data = tracks_SS_08, aes(x = dist_slope, y = `TOL_125`)) + 
  geom_point() + 
  geom_smooth(color = "green") +
  theme_classic()
```

Another map - need to decide if important to keep
```{r}
# Plot
oceanBase <- get_tiles(tracks_SS_08, provider="Esri.NatGeoWorldMap", crop = TRUE)
tm_shape(oceanBase) + tm_rgb() +
  tm_shape(tracks_SS_08) +  tm_symbols(col="species", size = 1) +
  tm_layout(legend.width = 0.5, 
            legend.position = c("right","top"))


#Raster base map
oceanBase <- get_tiles(tracks_SS_10, provider="Esri.NatGeoWorldMap")
tm_shape(bathy) + tm_raster() +
  tm_shape(tracks_SS_10) + 
  tm_symbols(style = "jenks") +
  tm_layout(legend.width = 0.5)
```

```{r}
# Plots for coastline and continental slope. Do I keep?
sf08 <- st_as_sf(tracks_SS_08, coords = c("Longitude", "Latitude"), crs=4326, remove=F)
sf10 <- st_as_sf(tracks_SS_10, coords = c("Longitude", "Latitude"), crs=4326, remove=F)
trkraster08 <- rasterize(vect(sf08), agg)
trkraster10 <- rasterize(vect(sf10), agg)

bathy_df <- as.data.frame(bathy, xy = TRUE)

# Map the coastline and cont. slope
cont <- st_as_sf(as.contour(bathy, ))
coast <- cont %>% filter(level == 0)
cont_slope <- cont %>% filter(level == -2000) #Is 2000m the correct depth for continental shelf?
cont_slope_rast <- rasterize(cont_slope, agg, field = "level")
plot(agg)
plot(cont_slope_rast, col = "red")
cont_slope_rast <- rasterize(cont_slope, agg)
plot(cont_slope_rast, col = "red")
  
ggplot() + 
  geom_sf(data = cont, col="black") + 
  geom_sf(data = coast, col = "red") +
  geom_sf(data = cont_slope, col = "purple") +
  #geom_sf(data = whales_8_10sf, mapping = aes()) +
  scale_color_gradient(low="green", high="red")
```

